-- Ducky Auto Defense v3.2 - IMPROVED & BUG-FIXED EDITION
-- Automatic base protection with ESP detection & admin integration
-- IMPROVEMENTS: Better error handling, performance optimization, memory leak fixes
-- Created by Ducky Team - Enhanced by Claude

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer

print("üõ°Ô∏è Ducky Auto Defense v3.2 (Improved) loading...")

-- Premium Color Palette
local COLORS = {
	PRIMARY = Color3.fromRGB(99, 102, 241),
	PRIMARY_LIGHT = Color3.fromRGB(129, 140, 248),
	PRIMARY_DARK = Color3.fromRGB(79, 70, 229),
	PRIMARY_GLOW = Color3.fromRGB(139, 150, 255),
	
	ACCENT = Color3.fromRGB(236, 72, 153),
	ACCENT_LIGHT = Color3.fromRGB(251, 113, 133),
	ACCENT_DARK = Color3.fromRGB(219, 39, 119),
	
	SUCCESS = Color3.fromRGB(34, 197, 94),
	SUCCESS_GLOW = Color3.fromRGB(74, 222, 128),
	WARNING = Color3.fromRGB(251, 146, 60),
	DANGER = Color3.fromRGB(239, 68, 68),
	
	BG_GLASS = Color3.fromRGB(15, 23, 42),
	BG_GLASS_LIGHT = Color3.fromRGB(30, 41, 59),
	BG_DARK = Color3.fromRGB(2, 6, 23),
	BG_CARD = Color3.fromRGB(20, 28, 48),
	
	TEXT = Color3.fromRGB(248, 250, 252),
	TEXT_MUTED = Color3.fromRGB(148, 163, 184),
	TEXT_DARK = Color3.fromRGB(100, 116, 139),
}

-- Animation presets
local ANIM = {
	INSTANT = TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
	FAST = TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
	SMOOTH = TweenInfo.new(0.4, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut),
	BOUNCE = TweenInfo.new(0.5, Enum.EasingStyle.Back, Enum.EasingDirection.Out),
	ELASTIC = TweenInfo.new(0.7, Enum.EasingStyle.Elastic, Enum.EasingDirection.Out),
}

-- Defense Settings
local Settings = {
	-- Main toggles
	DefenseEnabled = false,
	StealerProtectorEnabled = false,
	BaseDetectorEnabled = false,
	AutoAdminPanel = true,
	NotifyOnIntruder = true,
	ShowESP = true,
	
	-- Detection settings
	DefenseRange = 50,
	DetectionDelay = 0.5,
	CooldownTime = 15,
	
	-- Admin commands
	UseAdminCommands = true,
	AdminCommands = {"balloon", "ragdoll", "jail", "jumpscare", "inverse"},
	CommandDelay = 0.2,
	
	-- ESP settings
	ESPColor = COLORS.DANGER,
	ESPThickness = 2,
	ShowDistance = true,
	ShowName = true,
}

-- State management
local detectionConnections = {}
local intruderCooldowns = {}
local stealerCooldowns = {}
local playerCards = {}
local playerESP = {}
local baseCenter = nil
local baseBounds = nil
local currentTab = "Main"
local isShuttingDown = false
local activeTweens = {}

-- Create UI
local gui = Instance.new("ScreenGui")
gui.Name = "DuckyAutoDefense"
gui.ResetOnSpawn = false
gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
gui.DisplayOrder = 9998

local success, playerGui = pcall(function()
	return player:WaitForChild("PlayerGui", 5)
end)

if success and playerGui then
	gui.Parent = playerGui
else
	warn("‚ö†Ô∏è Could not find PlayerGui")
	return
end

-- Utility: Safe destroy
local function safeDestroy(instance)
	if instance and typeof(instance) == "Instance" then
		pcall(function()
			instance:Destroy()
		end)
	end
end

-- Utility: Safe disconnect
local function safeDisconnect(connection)
	if connection and typeof(connection) == "RBXScriptConnection" then
		pcall(function()
			connection:Disconnect()
		end)
	end
end

-- Utility: Create tween with tracking
local function createTrackedTween(instance, tweenInfo, properties)
	local tween = TweenService:Create(instance, tweenInfo, properties)
	table.insert(activeTweens, tween)
	
	tween.Completed:Connect(function()
		local index = table.find(activeTweens, tween)
		if index then
			table.remove(activeTweens, index)
		end
	end)
	
	return tween
end

-- Main Defense Panel
local defensePanel = Instance.new("Frame", gui)
defensePanel.Size = UDim2.fromOffset(520, 720)
defensePanel.Position = UDim2.new(0.5, -260, 0.5, -360)
defensePanel.BackgroundColor3 = COLORS.BG_GLASS
defensePanel.BackgroundTransparency = 0.08
defensePanel.BorderSizePixel = 0
defensePanel.Active = true
defensePanel.ClipsDescendants = true

local panelCorner = Instance.new("UICorner", defensePanel)
panelCorner.CornerRadius = UDim.new(0, 28)

local panelStroke = Instance.new("UIStroke", defensePanel)
panelStroke.Color = COLORS.DANGER
panelStroke.Thickness = 3
panelStroke.Transparency = 0.2

-- Glass effect layers
local glassLayer1 = Instance.new("Frame", defensePanel)
glassLayer1.Size = UDim2.fromScale(1, 1)
glassLayer1.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
glassLayer1.BackgroundTransparency = 0.95
glassLayer1.BorderSizePixel = 0
glassLayer1.ZIndex = 1
Instance.new("UICorner", glassLayer1).CornerRadius = UDim.new(0, 28)

local glassLayer2 = Instance.new("Frame", defensePanel)
glassLayer2.Size = UDim2.fromScale(1, 0.25)
glassLayer2.BackgroundColor3 = COLORS.DANGER
glassLayer2.BackgroundTransparency = 0.9
glassLayer2.BorderSizePixel = 0
glassLayer2.ZIndex = 1
Instance.new("UICorner", glassLayer2).CornerRadius = UDim.new(0, 28)

local layer2Gradient = Instance.new("UIGradient", glassLayer2)
layer2Gradient.Color = ColorSequence.new({
	ColorSequenceKeypoint.new(0, COLORS.DANGER),
	ColorSequenceKeypoint.new(0.5, COLORS.WARNING),
	ColorSequenceKeypoint.new(1, COLORS.DANGER)
})
layer2Gradient.Rotation = 45
layer2Gradient.Transparency = NumberSequence.new({
	NumberSequenceKeypoint.new(0, 0),
	NumberSequenceKeypoint.new(1, 1)
})

-- Animated gradient (with proper cleanup)
local gradientAnimRunning = true
task.spawn(function()
	local rotation = 45
	while gradientAnimRunning and gui.Parent and layer2Gradient.Parent do
		rotation = (rotation + 0.5) % 360
		layer2Gradient.Rotation = rotation
		task.wait(0.03)
	end
end)

-- Panel glow
local panelGlow = Instance.new("ImageLabel", defensePanel)
panelGlow.Size = UDim2.fromScale(1.03, 1.03)
panelGlow.Position = UDim2.fromScale(0.5, 0.5)
panelGlow.AnchorPoint = Vector2.new(0.5, 0.5)
panelGlow.BackgroundTransparency = 1
panelGlow.Image = "rbxassetid://5028857084"
panelGlow.ImageColor3 = COLORS.DANGER
panelGlow.ImageTransparency = 0.6
panelGlow.ScaleType = Enum.ScaleType.Slice
panelGlow.SliceCenter = Rect.new(24, 24, 276, 276)
panelGlow.ZIndex = 0

-- Draggable functionality
local dragging, dragInput, mousePos, framePos

defensePanel.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = true
		mousePos = input.Position
		framePos = defensePanel.Position
		
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then
				dragging = false
			end
		end)
	end
end)

UserInputService.InputChanged:Connect(function(input)
	if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
		local delta = input.Position - mousePos
		createTrackedTween(defensePanel, ANIM.INSTANT, {
			Position = UDim2.new(
				framePos.X.Scale, framePos.X.Offset + delta.X,
				framePos.Y.Scale, framePos.Y.Offset + delta.Y
			)
		}):Play()
	end
end)

-- Header
local header = Instance.new("Frame", defensePanel)
header.Size = UDim2.fromOffset(520, 120)
header.BackgroundColor3 = COLORS.BG_CARD
header.BackgroundTransparency = 0.25
header.BorderSizePixel = 0
header.ZIndex = 3
Instance.new("UICorner", header).CornerRadius = UDim.new(0, 28)

-- Header gradient
local headerGrad = Instance.new("Frame", header)
headerGrad.Size = UDim2.fromScale(1, 0.45)
headerGrad.BackgroundColor3 = COLORS.DANGER
headerGrad.BackgroundTransparency = 0.86
headerGrad.BorderSizePixel = 0
headerGrad.ZIndex = 3
local headerGradCorner = Instance.new("UICorner", headerGrad)
headerGradCorner.CornerRadius = UDim.new(0, 28)
local headerGradGrad = Instance.new("UIGradient", headerGrad)
headerGradGrad.Transparency = NumberSequence.new({
	NumberSequenceKeypoint.new(0, 0),
	NumberSequenceKeypoint.new(1, 1)
})
headerGradGrad.Rotation = 90

-- Shield icon container
local shieldContainer = Instance.new("Frame", header)
shieldContainer.Size = UDim2.fromOffset(80, 80)
shieldContainer.Position = UDim2.fromOffset(15, 20)
shieldContainer.BackgroundColor3 = COLORS.DANGER
shieldContainer.BackgroundTransparency = 0.85
shieldContainer.BorderSizePixel = 0
shieldContainer.ZIndex = 4
Instance.new("UICorner", shieldContainer).CornerRadius = UDim.new(0, 18)

local shieldStroke = Instance.new("UIStroke", shieldContainer)
shieldStroke.Color = COLORS.DANGER
shieldStroke.Thickness = 2
shieldStroke.Transparency = 0.4

local shieldIcon = Instance.new("TextLabel", shieldContainer)
shieldIcon.Size = UDim2.fromScale(1, 1)
shieldIcon.BackgroundTransparency = 1
shieldIcon.Text = "üõ°Ô∏è"
shieldIcon.Font = Enum.Font.GothamBold
shieldIcon.TextSize = 52
shieldIcon.ZIndex = 5

local titleLabel = Instance.new("TextLabel", header)
titleLabel.Size = UDim2.fromOffset(330, 36)
titleLabel.Position = UDim2.fromOffset(110, 22)
titleLabel.BackgroundTransparency = 1
titleLabel.Text = "AUTO DEFENSE v3.2"
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextSize = 24
titleLabel.TextColor3 = COLORS.TEXT
titleLabel.TextXAlignment = Enum.TextXAlignment.Left
titleLabel.ZIndex = 4

local subtitle = Instance.new("TextLabel", header)
subtitle.Size = UDim2.fromOffset(330, 22)
subtitle.Position = UDim2.fromOffset(110, 62)
subtitle.BackgroundTransparency = 1
subtitle.Text = "Enhanced Performance & Bug Fixes"
subtitle.Font = Enum.Font.Gotham
subtitle.TextSize = 13
subtitle.TextColor3 = COLORS.TEXT_MUTED
subtitle.TextXAlignment = Enum.TextXAlignment.Left
subtitle.ZIndex = 4

-- Status badge
local statusBadge = Instance.new("Frame", header)
statusBadge.Size = UDim2.fromOffset(100, 34)
statusBadge.Position = UDim2.fromOffset(110, 88)
statusBadge.BackgroundColor3 = COLORS.DANGER
statusBadge.BackgroundTransparency = 0.12
statusBadge.BorderSizePixel = 0
statusBadge.ZIndex = 4
Instance.new("UICorner", statusBadge).CornerRadius = UDim.new(0, 12)

local statusStroke = Instance.new("UIStroke", statusBadge)
statusStroke.Color = COLORS.DANGER
statusStroke.Thickness = 2
statusStroke.Transparency = 0.3

local statusText = Instance.new("TextLabel", statusBadge)
statusText.Size = UDim2.fromScale(1, 1)
statusText.BackgroundTransparency = 1
statusText.Text = "OFFLINE"
statusText.Font = Enum.Font.GothamBold
statusText.TextSize = 13
statusText.TextColor3 = COLORS.TEXT
statusText.ZIndex = 5

-- Cleanup function
local function cleanup()
	if isShuttingDown then return end
	isShuttingDown = true
	
	print("üßπ Cleaning up Ducky Auto Defense...")
	
	-- Stop gradient animation
	gradientAnimRunning = false
	
	-- Disable all features
	Settings.DefenseEnabled = false
	Settings.StealerProtectorEnabled = false
	Settings.BaseDetectorEnabled = false
	
	-- Cancel all tweens
	for _, tween in ipairs(activeTweens) do
		pcall(function()
			tween:Cancel()
		end)
	end
	table.clear(activeTweens)
	
	-- Disconnect all connections
	for _, conn in pairs(detectionConnections) do
		safeDisconnect(conn)
	end
	table.clear(detectionConnections)
	
	-- Clean up player ESP
	for _, espData in pairs(playerESP) do
		safeDisconnect(espData.connection)
		safeDestroy(espData.box)
	end
	table.clear(playerESP)
	
	-- Clean up player cards
	for _, cardData in pairs(playerCards) do
		safeDisconnect(cardData.connection)
		safeDestroy(cardData.card)
	end
	table.clear(playerCards)
	
	-- Clear cooldowns
	table.clear(intruderCooldowns)
	table.clear(stealerCooldowns)
	
	-- Destroy GUI
	safeDestroy(gui)
	
	print("‚úÖ Cleanup complete")
end

-- Close button
local closeBtn = Instance.new("TextButton", header)
closeBtn.Size = UDim2.fromOffset(45, 45)
closeBtn.Position = UDim2.fromOffset(460, 15)
closeBtn.BackgroundColor3 = COLORS.DANGER
closeBtn.BackgroundTransparency = 0.75
closeBtn.Text = "‚úï"
closeBtn.Font = Enum.Font.GothamBold
closeBtn.TextSize = 22
closeBtn.TextColor3 = COLORS.TEXT
closeBtn.BorderSizePixel = 0
closeBtn.AutoButtonColor = false
closeBtn.ZIndex = 4
Instance.new("UICorner", closeBtn).CornerRadius = UDim.new(0, 14)

closeBtn.MouseButton1Click:Connect(function()
	cleanup()
	print("üëã Ducky Auto Defense closed")
end)

-- Tab buttons container
local tabsContainer = Instance.new("Frame", defensePanel)
tabsContainer.Size = UDim2.fromOffset(490, 50)
tabsContainer.Position = UDim2.fromOffset(15, 132)
tabsContainer.BackgroundTransparency = 1
tabsContainer.ZIndex = 3

local tabsLayout = Instance.new("UIListLayout", tabsContainer)
tabsLayout.FillDirection = Enum.FillDirection.Horizontal
tabsLayout.SortOrder = Enum.SortOrder.LayoutOrder
tabsLayout.Padding = UDim.new(0, 10)

-- Content container
local contentContainer = Instance.new("Frame", defensePanel)
contentContainer.Size = UDim2.fromOffset(490, 520)
contentContainer.Position = UDim2.fromOffset(15, 192)
contentContainer.BackgroundTransparency = 1
contentContainer.ZIndex = 3

-- Helper: Create tab button
local function createTabButton(name, icon, order)
	local btn = Instance.new("TextButton", tabsContainer)
	btn.Name = name .. "Tab"
	btn.Size = UDim2.fromOffset(155, 50)
	btn.BackgroundColor3 = COLORS.BG_CARD
	btn.BackgroundTransparency = 0.3
	btn.BorderSizePixel = 0
	btn.AutoButtonColor = false
	btn.LayoutOrder = order
	btn.ZIndex = 4
	Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 14)
	
	local stroke = Instance.new("UIStroke", btn)
	stroke.Color = COLORS.PRIMARY
	stroke.Thickness = 1.5
	stroke.Transparency = 0.65
	
	local iconLabel = Instance.new("TextLabel", btn)
	iconLabel.Size = UDim2.fromOffset(30, 30)
	iconLabel.Position = UDim2.fromOffset(10, 10)
	iconLabel.BackgroundTransparency = 1
	iconLabel.Text = icon
	iconLabel.TextSize = 20
	iconLabel.ZIndex = 5
	
	local label = Instance.new("TextLabel", btn)
	label.Size = UDim2.fromOffset(105, 50)
	label.Position = UDim2.fromOffset(45, 0)
	label.BackgroundTransparency = 1
	label.Text = name
	label.Font = Enum.Font.GothamBold
	label.TextSize = 13
	label.TextColor3 = COLORS.TEXT_MUTED
	label.TextXAlignment = Enum.TextXAlignment.Left
	label.ZIndex = 5
	
	btn.MouseButton1Click:Connect(function()
		currentTab = name
		-- Update all tab buttons
		for _, child in pairs(tabsContainer:GetChildren()) do
			if child:IsA("TextButton") then
				local childStroke = child:FindFirstChildOfClass("UIStroke")
				if child == btn then
					createTrackedTween(child, ANIM.SMOOTH, {BackgroundTransparency = 0.1}):Play()
					createTrackedTween(childStroke, ANIM.SMOOTH, {Color = COLORS.DANGER, Transparency = 0.3}):Play()
					for _, lbl in pairs(child:GetChildren()) do
						if lbl:IsA("TextLabel") then
							lbl.TextColor3 = COLORS.TEXT
						end
					end
				else
					createTrackedTween(child, ANIM.SMOOTH, {BackgroundTransparency = 0.3}):Play()
					createTrackedTween(childStroke, ANIM.SMOOTH, {Color = COLORS.PRIMARY, Transparency = 0.65}):Play()
					for _, lbl in pairs(child:GetChildren()) do
						if lbl:IsA("TextLabel") then
							lbl.TextColor3 = COLORS.TEXT_MUTED
						end
					end
				end
			end
		end
		-- Update content
		for _, child in pairs(contentContainer:GetChildren()) do
			if child:IsA("Frame") or child:IsA("ScrollingFrame") then
				child.Visible = (child.Name == name .. "Content")
			end
		end
	end)
	
	return btn
end

-- Create tabs
local mainTab = createTabButton("Main", "üõ°Ô∏è", 1)
local optionsTab = createTabButton("Options", "‚öôÔ∏è", 2)
local playersTab = createTabButton("Players", "üë•", 3)

-- Set initial tab
mainTab.BackgroundTransparency = 0.1
local mainTabStroke = mainTab:FindFirstChildOfClass("UIStroke")
mainTabStroke.Color = COLORS.DANGER
mainTabStroke.Transparency = 0.3
for _, lbl in pairs(mainTab:GetChildren()) do
	if lbl:IsA("TextLabel") then
		lbl.TextColor3 = COLORS.TEXT
	end
end

-- Helper: Create toggle switch
local function createToggle(parent, yPos, text, icon, defaultState, callback)
	local container = Instance.new("Frame", parent)
	container.Size = UDim2.fromOffset(490, 60)
	container.Position = UDim2.fromOffset(0, yPos)
	container.BackgroundColor3 = COLORS.BG_CARD
	container.BackgroundTransparency = 0.3
	container.BorderSizePixel = 0
	container.ZIndex = 4
	Instance.new("UICorner", container).CornerRadius = UDim.new(0, 14)
	
	local stroke = Instance.new("UIStroke", container)
	stroke.Color = COLORS.PRIMARY
	stroke.Thickness = 1.5
	stroke.Transparency = 0.65
	
	local iconLabel = Instance.new("TextLabel", container)
	iconLabel.Size = UDim2.fromOffset(40, 40)
	iconLabel.Position = UDim2.fromOffset(15, 10)
	iconLabel.BackgroundTransparency = 1
	iconLabel.Text = icon
	iconLabel.TextSize = 28
	iconLabel.ZIndex = 5
	
	local label = Instance.new("TextLabel", container)
	label.Size = UDim2.fromOffset(340, 60)
	label.Position = UDim2.fromOffset(65, 0)
	label.BackgroundTransparency = 1
	label.Text = text
	label.Font = Enum.Font.GothamBold
	label.TextSize = 14
	label.TextColor3 = COLORS.TEXT
	label.TextXAlignment = Enum.TextXAlignment.Left
	label.ZIndex = 5
	
	local isOn = defaultState
	
	-- Toggle switch
	local toggleBg = Instance.new("Frame", container)
	toggleBg.Size = UDim2.fromOffset(60, 32)
	toggleBg.Position = UDim2.fromOffset(415, 14)
	toggleBg.BackgroundColor3 = isOn and COLORS.SUCCESS or COLORS.TEXT_DARK
	toggleBg.BackgroundTransparency = 0.3
	toggleBg.BorderSizePixel = 0
	toggleBg.ZIndex = 5
	Instance.new("UICorner", toggleBg).CornerRadius = UDim.new(1, 0)
	
	local toggleCircle = Instance.new("Frame", toggleBg)
	toggleCircle.Size = UDim2.fromOffset(26, 26)
	toggleCircle.Position = isOn and UDim2.fromOffset(31, 3) or UDim2.fromOffset(3, 3)
	toggleCircle.BackgroundColor3 = COLORS.TEXT
	toggleCircle.BorderSizePixel = 0
	toggleCircle.ZIndex = 6
	Instance.new("UICorner", toggleCircle).CornerRadius = UDim.new(1, 0)
	
	local toggleBtn = Instance.new("TextButton", container)
	toggleBtn.Size = container.Size
	toggleBtn.BackgroundTransparency = 1
	toggleBtn.Text = ""
	toggleBtn.ZIndex = 7
	
	local function updateToggle()
		createTrackedTween(toggleBg, ANIM.SMOOTH, {
			BackgroundColor3 = isOn and COLORS.SUCCESS or COLORS.TEXT_DARK
		}):Play()
		createTrackedTween(toggleCircle, ANIM.BOUNCE, {
			Position = isOn and UDim2.fromOffset(31, 3) or UDim2.fromOffset(3, 3)
		}):Play()
		if callback then 
			pcall(function()
				callback(isOn)
			end)
		end
	end
	
	toggleBtn.MouseButton1Click:Connect(function()
		isOn = not isOn
		updateToggle()
	end)
	
	return container, function() return isOn end, function(state) isOn = state updateToggle() end
end

-- Helper: Create slider
local function createSlider(parent, yPos, text, icon, minVal, maxVal, defaultVal, suffix, callback)
	local container = Instance.new("Frame", parent)
	container.Size = UDim2.fromOffset(490, 80)
	container.Position = UDim2.fromOffset(0, yPos)
	container.BackgroundColor3 = COLORS.BG_CARD
	container.BackgroundTransparency = 0.3
	container.BorderSizePixel = 0
	container.ZIndex = 4
	Instance.new("UICorner", container).CornerRadius = UDim.new(0, 14)
	
	local stroke = Instance.new("UIStroke", container)
	stroke.Color = COLORS.PRIMARY
	stroke.Thickness = 1.5
	stroke.Transparency = 0.65
	
	local iconLabel = Instance.new("TextLabel", container)
	iconLabel.Size = UDim2.fromOffset(40, 40)
	iconLabel.Position = UDim2.fromOffset(15, 10)
	iconLabel.BackgroundTransparency = 1
	iconLabel.Text = icon
	iconLabel.TextSize = 28
	iconLabel.ZIndex = 5
	
	local label = Instance.new("TextLabel", container)
	label.Size = UDim2.fromOffset(300, 25)
	label.Position = UDim2.fromOffset(65, 12)
	label.BackgroundTransparency = 1
	label.Text = text
	label.Font = Enum.Font.GothamBold
	label.TextSize = 14
	label.TextColor3 = COLORS.TEXT
	label.TextXAlignment = Enum.TextXAlignment.Left
	label.ZIndex = 5
	
	local valueLabel = Instance.new("TextLabel", container)
	valueLabel.Size = UDim2.fromOffset(100, 25)
	valueLabel.Position = UDim2.fromOffset(375, 12)
	valueLabel.BackgroundTransparency = 1
	valueLabel.Text = defaultVal .. suffix
	valueLabel.Font = Enum.Font.GothamBold
	valueLabel.TextSize = 14
	valueLabel.TextColor3 = COLORS.PRIMARY_LIGHT
	valueLabel.TextXAlignment = Enum.TextXAlignment.Right
	valueLabel.ZIndex = 5
	
	-- Slider track
	local sliderTrack = Instance.new("Frame", container)
	sliderTrack.Size = UDim2.fromOffset(400, 6)
	sliderTrack.Position = UDim2.fromOffset(65, 55)
	sliderTrack.BackgroundColor3 = COLORS.TEXT_DARK
	sliderTrack.BackgroundTransparency = 0.5
	sliderTrack.BorderSizePixel = 0
	sliderTrack.ZIndex = 5
	Instance.new("UICorner", sliderTrack).CornerRadius = UDim.new(1, 0)
	
	-- Slider fill
	local sliderFill = Instance.new("Frame", sliderTrack)
	sliderFill.Size = UDim2.fromScale((defaultVal - minVal) / (maxVal - minVal), 1)
	sliderFill.BackgroundColor3 = COLORS.PRIMARY_LIGHT
	sliderFill.BorderSizePixel = 0
	sliderFill.ZIndex = 6
	Instance.new("UICorner", sliderFill).CornerRadius = UDim.new(1, 0)
	
	-- Slider knob
	local sliderKnob = Instance.new("Frame", sliderTrack)
	sliderKnob.Size = UDim2.fromOffset(18, 18)
	sliderKnob.Position = UDim2.fromScale((defaultVal - minVal) / (maxVal - minVal), 0.5)
	sliderKnob.AnchorPoint = Vector2.new(0.5, 0.5)
	sliderKnob.BackgroundColor3 = COLORS.TEXT
	sliderKnob.BorderSizePixel = 0
	sliderKnob.ZIndex = 7
	Instance.new("UICorner", sliderKnob).CornerRadius = UDim.new(1, 0)
	
	local currentValue = defaultVal
	local dragging = false
	
	local function updateSlider(input)
		local relativeX = math.clamp((input.Position.X - sliderTrack.AbsolutePosition.X) / sliderTrack.AbsoluteSize.X, 0, 1)
		currentValue = math.floor(minVal + (maxVal - minVal) * relativeX)
		valueLabel.Text = currentValue .. suffix
		createTrackedTween(sliderFill, ANIM.INSTANT, {Size = UDim2.fromScale(relativeX, 1)}):Play()
		createTrackedTween(sliderKnob, ANIM.INSTANT, {Position = UDim2.fromScale(relativeX, 0.5)}):Play()
		if callback then
			pcall(function()
				callback(currentValue)
			end)
		end
	end
	
	sliderTrack.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = true
			updateSlider(input)
		end
	end)
	
	sliderTrack.InputEnded:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = false
		end
	end)
	
	local inputChangedConn = UserInputService.InputChanged:Connect(function(input)
		if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
			updateSlider(input)
		end
	end)
	
	-- Track connection for cleanup
	table.insert(detectionConnections, inputChangedConn)
	
	return container, function() return currentValue end
end

-- Helper: Send chat message (improved error handling)
local function sendChatMessage(message)
	local success, err = pcall(function()
		local TextChatService = game:GetService("TextChatService")
		if not TextChatService then return end
		
		local textChannels = TextChatService:FindFirstChild("TextChannels")
		if not textChannels then return end
		
		local textChannel = textChannels:FindFirstChild("RBXGeneral")
		if textChannel then
			textChannel:SendAsync(message)
		end
	end)
	
	if not success then
		warn("‚ö†Ô∏è Failed to send chat message:", err)
	end
end

-- Find player base (improved)
function findPlayerBase()
	local plotsFolder = workspace:FindFirstChild("Plots")
	if not plotsFolder then 
		warn("‚ö†Ô∏è No Plots folder found in workspace")
		return nil 
	end
	
	for _, plot in pairs(plotsFolder:GetChildren()) do
		if plot:IsA("Model") then
			local ownerValue = plot:FindFirstChild("Owner", true)
			if ownerValue then
				local ownerName = ""
				if ownerValue:IsA("StringValue") then
					ownerName = ownerValue.Value
				elseif ownerValue:IsA("ObjectValue") and ownerValue.Value then
					if ownerValue.Value:IsA("Player") then
						ownerName = ownerValue.Value.Name
					end
				end
				
				if ownerName == player.Name then
					return plot
				end
			end
		end
	end
	
	warn("‚ö†Ô∏è Could not find player's plot")
	return nil
end

-- Check if player is in base (with error handling)
local function isPlayerInBase(targetPlayer)
	if not baseCenter then return false end
	if not targetPlayer or not targetPlayer.Parent then return false end
	
	local success, result = pcall(function()
		local char = targetPlayer.Character
		if not char then return false end
		
		local hrp = char:FindFirstChild("HumanoidRootPart")
		if not hrp then return false end
		
		local distance = (hrp.Position - baseCenter).Magnitude
		return distance <= Settings.DefenseRange
	end)
	
	return success and result or false
end

-- Execute defense on intruder (improved)
local function executeDefenseOnIntruder(intruder, reason)
	if isShuttingDown then return end
	if not intruder or not intruder.Parent then return end
	if intruder == player then return end -- Don't target self
	
	-- Cooldown check
	local cooldownKey = intruder.UserId
	local cooldownTable = reason == "stealer" and stealerCooldowns or intruderCooldowns
	
	if cooldownTable[cooldownKey] and tick() - cooldownTable[cooldownKey] < Settings.CooldownTime then
		return
	end
	cooldownTable[cooldownKey] = tick()
	
	-- Notification
	if Settings.NotifyOnIntruder then
		print(string.format("üö® %s DETECTED: %s - EXECUTING DEFENSE!", reason:upper(), intruder.Name))
	end
	
	-- Auto admin panel
	if Settings.AutoAdminPanel and Settings.UseAdminCommands then
		for _, cmd in ipairs(Settings.AdminCommands) do
			pcall(function()
				local chatCommand = ";" .. cmd .. " " .. string.lower(intruder.Name)
				sendChatMessage(chatCommand)
			end)
			task.wait(Settings.CommandDelay)
		end
		print(string.format("‚úÖ Defense executed on %s (%s)", intruder.Name, reason))
	end
end

-- Monitor for stealing (improved with better detection)
local function monitorStealing(targetPlayer)
	if not Settings.StealerProtectorEnabled then return end
	if not targetPlayer or not targetPlayer.Parent then return end
	
	local function setupCharacterMonitoring(char)
		if not char then return end
		
		local childAddedConn = char.ChildAdded:Connect(function(child)
			if isShuttingDown then return end
			if not (child:IsA("Tool") or child:IsA("Accessory")) then return end
			
			task.wait(0.3)
			
			if isPlayerInBase(targetPlayer) and Settings.StealerProtectorEnabled then
				executeDefenseOnIntruder(targetPlayer, "stealer")
			end
		end)
		
		table.insert(detectionConnections, childAddedConn)
	end
	
	-- Monitor current character
	if targetPlayer.Character then
		setupCharacterMonitoring(targetPlayer.Character)
	end
	
	-- Monitor future characters
	local charAddedConn = targetPlayer.CharacterAdded:Connect(function(char)
		task.wait(0.5)
		setupCharacterMonitoring(char)
	end)
	
	table.insert(detectionConnections, charAddedConn)
end

-- Create ESP box for player (improved with better cleanup)
local function createESPBox(targetPlayer)
	if isShuttingDown then return nil end
	if not targetPlayer or not targetPlayer.Parent then return nil end
	if targetPlayer == player then return nil end
	
	-- Clean up existing ESP
	if playerESP[targetPlayer.UserId] then
		local existing = playerESP[targetPlayer.UserId]
		safeDisconnect(existing.connection)
		safeDestroy(existing.box)
		playerESP[targetPlayer.UserId] = nil
	end
	
	local char = targetPlayer.Character
	if not char then return nil end
	
	local hrp = char:FindFirstChild("HumanoidRootPart")
	if not hrp then return nil end
	
	-- Create ESP box
	local box = Instance.new("BillboardGui")
	box.Name = "ESP_" .. targetPlayer.Name
	box.Adornee = hrp
	box.Size = UDim2.fromOffset(200, 50)
	box.StudsOffset = Vector3.new(0, 3, 0)
	box.AlwaysOnTop = true
	box.Parent = hrp
	
	local frame = Instance.new("Frame", box)
	frame.Size = UDim2.fromScale(1, 1)
	frame.BackgroundTransparency = 1
	
	-- Box outline
	local outline = Instance.new("UIStroke", frame)
	outline.Color = Settings.ESPColor
	outline.Thickness = Settings.ESPThickness
	outline.Transparency = 0.3
	
	-- Name label
	local nameLabel = Instance.new("TextLabel", frame)
	nameLabel.Size = UDim2.fromScale(1, 0.4)
	nameLabel.BackgroundTransparency = 1
	nameLabel.Text = targetPlayer.Name
	nameLabel.Font = Enum.Font.GothamBold
	nameLabel.TextSize = 14
	nameLabel.TextColor3 = COLORS.TEXT
	nameLabel.TextStrokeTransparency = 0.5
	nameLabel.Visible = Settings.ShowName
	
	-- Distance label
	local distLabel = Instance.new("TextLabel", frame)
	distLabel.Size = UDim2.fromScale(1, 0.3)
	distLabel.Position = UDim2.fromScale(0, 0.4)
	distLabel.BackgroundTransparency = 1
	distLabel.Text = "0 studs"
	distLabel.Font = Enum.Font.Gotham
	distLabel.TextSize = 12
	distLabel.TextColor3 = COLORS.SUCCESS
	distLabel.TextStrokeTransparency = 0.5
	distLabel.Visible = Settings.ShowDistance
	
	-- Status label
	local statusLabel = Instance.new("TextLabel", frame)
	statusLabel.Size = UDim2.fromScale(1, 0.3)
	statusLabel.Position = UDim2.fromScale(0, 0.7)
	statusLabel.BackgroundTransparency = 1
	statusLabel.Text = "SAFE"
	statusLabel.Font = Enum.Font.GothamBold
	statusLabel.TextSize = 13
	statusLabel.TextColor3 = COLORS.SUCCESS
	statusLabel.TextStrokeTransparency = 0.5
	
	local lastDefenseCheck = 0
	
	-- Update ESP in real-time
	local connection = RunService.Heartbeat:Connect(function()
		if isShuttingDown then
			if connection then connection:Disconnect() end
			return
		end
		
		if not targetPlayer or not targetPlayer.Parent or not player or not player.Character then
			safeDisconnect(connection)
			safeDestroy(box)
			playerESP[targetPlayer.UserId] = nil
			return
		end
		
		local myHRP = player.Character:FindFirstChild("HumanoidRootPart")
		local theirChar = targetPlayer.Character
		local theirHRP = theirChar and theirChar:FindFirstChild("HumanoidRootPart")
		
		if myHRP and theirHRP then
			local distance = (myHRP.Position - theirHRP.Position).Magnitude
			distLabel.Text = string.format("%.0f studs", distance)
			
			-- Check if in base
			local inBase = isPlayerInBase(targetPlayer)
			if inBase and Settings.BaseDetectorEnabled then
				-- IN BASE - THREAT
				statusLabel.Text = "IN BASE ‚ö†Ô∏è"
				statusLabel.TextColor3 = COLORS.DANGER
				outline.Color = COLORS.DANGER
				distLabel.TextColor3 = COLORS.DANGER
				
				-- Auto defense (with debounce)
				if Settings.DefenseEnabled and tick() - lastDefenseCheck > Settings.DetectionDelay then
					lastDefenseCheck = tick()
					task.spawn(function()
						task.wait(Settings.DetectionDelay)
						if isPlayerInBase(targetPlayer) then
							executeDefenseOnIntruder(targetPlayer, "intruder")
						end
					end)
				end
			else
				-- SAFE
				statusLabel.Text = "SAFE ‚úì"
				statusLabel.TextColor3 = COLORS.SUCCESS
				outline.Color = Settings.ESPColor
				
				if distance < 50 then
					distLabel.TextColor3 = COLORS.WARNING
				else
					distLabel.TextColor3 = COLORS.SUCCESS
				end
			end
		end
		
		-- Update visibility based on settings
		nameLabel.Visible = Settings.ShowName
		distLabel.Visible = Settings.ShowDistance
		box.Enabled = Settings.ShowESP
	end)
	
	-- Monitor stealing for this player
	monitorStealing(targetPlayer)
	
	playerESP[targetPlayer.UserId] = {
		box = box,
		connection = connection
	}
	
	return playerESP[targetPlayer.UserId]
end

-- Create player card (improved)
local function createPlayerCard(targetPlayer)
	if isShuttingDown then return nil end
	if not targetPlayer or not targetPlayer.Parent then return nil end
	if targetPlayer == player then return nil end
	
	-- Clean up existing card
	if playerCards[targetPlayer.UserId] then
		local existing = playerCards[targetPlayer.UserId]
		safeDisconnect(existing.connection)
		safeDestroy(existing.card)
		playerCards[targetPlayer.UserId] = nil
	end
	
	local card = Instance.new("Frame", playersList)
	card.Name = "PlayerCard_" .. targetPlayer.Name
	card.Size = UDim2.fromOffset(454, 90)
	card.BackgroundColor3 = COLORS.BG_GLASS
	card.BackgroundTransparency = 0.35
	card.BorderSizePixel = 0
	card.ZIndex = 4
	Instance.new("UICorner", card).CornerRadius = UDim.new(0, 14)
	
	local cardStroke = Instance.new("UIStroke", card)
	cardStroke.Color = COLORS.PRIMARY
	cardStroke.Thickness = 1.5
	cardStroke.Transparency = 0.65
	
	-- Avatar
	local avatar = Instance.new("ImageLabel", card)
	avatar.Size = UDim2.fromOffset(70, 70)
	avatar.Position = UDim2.fromOffset(10, 10)
	avatar.BackgroundColor3 = COLORS.BG_DARK
	avatar.BorderSizePixel = 0
	avatar.Image = "rbxthumb://type=AvatarHeadShot&id=" .. targetPlayer.UserId .. "&w=150&h=150"
	avatar.ZIndex = 5
	Instance.new("UICorner", avatar).CornerRadius = UDim.new(0, 12)
	
	local avatarStroke = Instance.new("UIStroke", avatar)
	avatarStroke.Color = COLORS.PRIMARY_LIGHT
	avatarStroke.Thickness = 2
	avatarStroke.Transparency = 0.5
	
	-- Username
	local username = Instance.new("TextLabel", card)
	username.Size = UDim2.fromOffset(240, 22)
	username.Position = UDim2.fromOffset(90, 12)
	username.BackgroundTransparency = 1
	username.Text = targetPlayer.Name
	username.Font = Enum.Font.GothamBold
	username.TextSize = 14
	username.TextColor3 = COLORS.TEXT
	username.TextXAlignment = Enum.TextXAlignment.Left
	username.TextTruncate = Enum.TextTruncate.AtEnd
	username.ZIndex = 5
	
	-- Display name
	local displayName = Instance.new("TextLabel", card)
	displayName.Size = UDim2.fromOffset(240, 18)
	displayName.Position = UDim2.fromOffset(90, 36)
	displayName.BackgroundTransparency = 1
	displayName.Text = "@" .. targetPlayer.DisplayName
	displayName.Font = Enum.Font.Gotham
	displayName.TextSize = 11
	displayName.TextColor3 = COLORS.TEXT_MUTED
	displayName.TextXAlignment = Enum.TextXAlignment.Left
	displayName.TextTruncate = Enum.TextTruncate.AtEnd
	displayName.ZIndex = 5
	
	-- Distance label
	local distanceLabel = Instance.new("TextLabel", card)
	distanceLabel.Size = UDim2.fromOffset(240, 20)
	distanceLabel.Position = UDim2.fromOffset(90, 58)
	distanceLabel.BackgroundTransparency = 1
	distanceLabel.Text = "üìè Calculating..."
	distanceLabel.Font = Enum.Font.GothamBold
	distanceLabel.TextSize = 13
	distanceLabel.TextColor3 = COLORS.SUCCESS
	distanceLabel.TextXAlignment = Enum.TextXAlignment.Left
	distanceLabel.ZIndex = 5
	
	-- Status indicator
	local statusIndicator = Instance.new("Frame", card)
	statusIndicator.Size = UDim2.fromOffset(85, 28)
	statusIndicator.Position = UDim2.fromOffset(359, 12)
	statusIndicator.BackgroundColor3 = COLORS.SUCCESS
	statusIndicator.BackgroundTransparency = 0.15
	statusIndicator.BorderSizePixel = 0
	statusIndicator.ZIndex = 5
	Instance.new("UICorner", statusIndicator).CornerRadius = UDim.new(0, 10)
	
	local statusStroke = Instance.new("UIStroke", statusIndicator)
	statusStroke.Color = COLORS.SUCCESS
	statusStroke.Thickness = 1.5
	statusStroke.Transparency = 0.4
	
	local statusText = Instance.new("TextLabel", statusIndicator)
	statusText.Size = UDim2.fromScale(1, 1)
	statusText.BackgroundTransparency = 1
	statusText.Text = "SAFE"
	statusText.Font = Enum.Font.GothamBold
	statusText.TextSize = 11
	statusText.TextColor3 = COLORS.TEXT
	statusText.ZIndex = 6
	
	-- Attack button
	local attackBtn = Instance.new("TextButton", card)
	attackBtn.Size = UDim2.fromOffset(85, 28)
	attackBtn.Position = UDim2.fromOffset(359, 52)
	attackBtn.BackgroundColor3 = COLORS.DANGER
	attackBtn.BackgroundTransparency = 0.15
	attackBtn.Text = "DEFEND"
	attackBtn.Font = Enum.Font.GothamBold
	attackBtn.TextSize = 11
	attackBtn.TextColor3 = COLORS.TEXT
	attackBtn.BorderSizePixel = 0
	attackBtn.AutoButtonColor = false
	attackBtn.ZIndex = 5
	Instance.new("UICorner", attackBtn).CornerRadius = UDim.new(0, 10)
	
	local attackStroke = Instance.new("UIStroke", attackBtn)
	attackStroke.Color = COLORS.DANGER
	attackStroke.Thickness = 1.5
	attackStroke.Transparency = 0.4
	
	local attackCooldown = false
	attackBtn.MouseButton1Click:Connect(function()
		if attackCooldown then return end
		if not Settings.UseAdminCommands then
			print("‚ö†Ô∏è Admin commands are disabled!")
			return
		end
		
		attackCooldown = true
		attackBtn.Text = "ATTACKING..."
		executeDefenseOnIntruder(targetPlayer, "manual")
		
		task.wait(2)
		if attackBtn and attackBtn.Parent then
			attackBtn.Text = "DEFEND"
		end
		attackCooldown = false
	end)
	
	-- Update distance in real-time
	local updateConnection = RunService.Heartbeat:Connect(function()
		if isShuttingDown then
			if updateConnection then updateConnection:Disconnect() end
			return
		end
		
		if not targetPlayer or not targetPlayer.Parent or not player or not player.Character then
			safeDisconnect(updateConnection)
			safeDestroy(card)
			playerCards[targetPlayer.UserId] = nil
			return
		end
		
		local success, err = pcall(function()
			local myHRP = player.Character:FindFirstChild("HumanoidRootPart")
			local theirChar = targetPlayer.Character
			local theirHRP = theirChar and theirChar:FindFirstChild("HumanoidRootPart")
			
			if myHRP and theirHRP then
				local distance = (myHRP.Position - theirHRP.Position).Magnitude
				distanceLabel.Text = string.format("üìè %.0f studs", distance)
				
				-- Check if in base
				local inBase = isPlayerInBase(targetPlayer)
				if inBase and Settings.BaseDetectorEnabled then
					-- IN BASE - THREAT
					statusText.Text = "IN BASE"
					createTrackedTween(statusIndicator, ANIM.FAST, {BackgroundColor3 = COLORS.DANGER}):Play()
					createTrackedTween(statusStroke, ANIM.FAST, {Color = COLORS.DANGER}):Play()
					createTrackedTween(cardStroke, ANIM.FAST, {Color = COLORS.DANGER, Transparency = 0.4}):Play()
					createTrackedTween(avatarStroke, ANIM.FAST, {Color = COLORS.DANGER}):Play()
				else
					-- SAFE
					statusText.Text = "SAFE"
					createTrackedTween(statusIndicator, ANIM.FAST, {BackgroundColor3 = COLORS.SUCCESS}):Play()
					createTrackedTween(statusStroke, ANIM.FAST, {Color = COLORS.SUCCESS}):Play()
					createTrackedTween(cardStroke, ANIM.FAST, {Color = COLORS.PRIMARY, Transparency = 0.65}):Play()
					createTrackedTween(avatarStroke, ANIM.FAST, {Color = COLORS.PRIMARY_LIGHT}):Play()
				end
				
				-- Update distance color
				if distance < 50 then
					distanceLabel.TextColor3 = COLORS.DANGER
				elseif distance < 150 then
					distanceLabel.TextColor3 = COLORS.WARNING
				else
					distanceLabel.TextColor3 = COLORS.SUCCESS
				end
			end
		end)
		
		if not success then
			warn("‚ö†Ô∏è Error updating player card:", err)
		end
	end)
	
	playerCards[targetPlayer.UserId] = {
		card = card,
		connection = updateConnection
	}
	
	-- Also create ESP for this player
	createESPBox(targetPlayer)
	
	return playerCards[targetPlayer.UserId]
end

-- Refresh player list
local function refreshPlayerList()
	for _, targetPlayer in pairs(Players:GetPlayers()) do
		if targetPlayer ~= player then
			pcall(function()
				createPlayerCard(targetPlayer)
				createESPBox(targetPlayer)
			end)
		end
	end
end

-- MAIN TAB CONTENT
local mainContent = Instance.new("ScrollingFrame", contentContainer)
mainContent.Name = "MainContent"
mainContent.Size = UDim2.fromScale(1, 1)
mainContent.BackgroundTransparency = 1
mainContent.BorderSizePixel = 0
mainContent.ScrollBarThickness = 6
mainContent.ScrollBarImageColor3 = COLORS.DANGER
mainContent.ScrollBarImageTransparency = 0.3
mainContent.CanvasSize = UDim2.fromOffset(490, 0)
mainContent.AutomaticCanvasSize = Enum.AutomaticSize.Y
mainContent.Visible = true
mainContent.ZIndex = 3

local mainLayout = Instance.new("UIListLayout", mainContent)
mainLayout.SortOrder = Enum.SortOrder.LayoutOrder
mainLayout.Padding = UDim.new(0, 12)

-- Main toggles
local stealerToggle = createToggle(
	mainContent, 0, "Stealer Protector", "üîí", false,
	function(state)
		Settings.StealerProtectorEnabled = state
		print("üîí Stealer Protector:", state and "ENABLED" or "DISABLED")
		if state and not Settings.DefenseEnabled then
			Settings.DefenseEnabled = true
			statusText.Text = "ONLINE"
			createTrackedTween(statusBadge, ANIM.SMOOTH, {BackgroundColor3 = COLORS.SUCCESS}):Play()
			createTrackedTween(statusStroke, ANIM.SMOOTH, {Color = COLORS.SUCCESS_GLOW}):Play()
			print("üõ°Ô∏è Auto Defense: ONLINE (via Stealer Protector)")
		elseif not state and not Settings.BaseDetectorEnabled then
			Settings.DefenseEnabled = false
			statusText.Text = "OFFLINE"
			createTrackedTween(statusBadge, ANIM.SMOOTH, {BackgroundColor3 = COLORS.DANGER}):Play()
			createTrackedTween(statusStroke, ANIM.SMOOTH, {Color = COLORS.DANGER}):Play()
		end
	end
)

local baseToggle = createToggle(
	mainContent, 72, "Base Detector", "üè†", false,
	function(state)
		Settings.BaseDetectorEnabled = state
		print("üè† Base Detector:", state and "ENABLED" or "DISABLED")
		if state then
			-- Find base when enabled
			local myBase = findPlayerBase()
			if myBase then
				baseCenter = myBase:GetPivot().Position
				baseBounds = myBase:GetExtentsSize()
				print("üõ°Ô∏è Base located at:", baseCenter)
				
				if not Settings.DefenseEnabled then
					Settings.DefenseEnabled = true
					statusText.Text = "ONLINE"
					createTrackedTween(statusBadge, ANIM.SMOOTH, {BackgroundColor3 = COLORS.SUCCESS}):Play()
					createTrackedTween(statusStroke, ANIM.SMOOTH, {Color = COLORS.SUCCESS_GLOW}):Play()
					print("üõ°Ô∏è Auto Defense: ONLINE (via Base Detector)")
				end
			else
				warn("‚ö†Ô∏è Could not find your base! Set it manually in Options tab.")
			end
		elseif not state and not Settings.StealerProtectorEnabled then
			Settings.DefenseEnabled = false
			statusText.Text = "OFFLINE"
			createTrackedTween(statusBadge, ANIM.SMOOTH, {BackgroundColor3 = COLORS.DANGER}):Play()
			createTrackedTween(statusStroke, ANIM.SMOOTH, {Color = COLORS.DANGER}):Play()
		end
	end
)

local notifyToggle = createToggle(
	mainContent, 144, "Notify on Intruder", "üîî", true,
	function(state)
		Settings.NotifyOnIntruder = state
		print("üîî Notifications:", state and "ENABLED" or "DISABLED")
	end
)

local espToggle = createToggle(
	mainContent, 216, "Show ESP Boxes", "üì¶", true,
	function(state)
		Settings.ShowESP = state
		-- Update all ESP
		for _, espData in pairs(playerESP) do
			if espData.box then
				espData.box.Enabled = state
			end
		end
		print("üì¶ ESP:", state and "ENABLED" or "DISABLED")
	end
)

-- Info section
local infoSection = Instance.new("Frame", mainContent)
infoSection.Size = UDim2.fromOffset(490, 120)
infoSection.BackgroundColor3 = COLORS.BG_CARD
infoSection.BackgroundTransparency = 0.3
infoSection.BorderSizePixel = 0
infoSection.ZIndex = 4
Instance.new("UICorner", infoSection).CornerRadius = UDim.new(0, 14)

local infoStroke = Instance.new("UIStroke", infoSection)
infoStroke.Color = COLORS.PRIMARY
infoStroke.Thickness = 1.5
infoStroke.Transparency = 0.65

local infoText = Instance.new("TextLabel", infoSection)
infoText.Size = UDim2.fromOffset(470, 100)
infoText.Position = UDim2.fromOffset(10, 10)
infoText.BackgroundTransparency = 1
infoText.Text = "üîí Stealer Protector: Auto admin panels anyone who steals items\nüè† Base Detector: Auto admin panels players who enter your base\n\nv3.2 IMPROVEMENTS:\n‚úÖ Better error handling ‚Ä¢ Memory leak fixes ‚Ä¢ Performance optimized"
infoText.Font = Enum.Font.Gotham
infoText.TextSize = 11
infoText.TextColor3 = COLORS.TEXT_MUTED
infoText.TextXAlignment = Enum.TextXAlignment.Left
infoText.TextYAlignment = Enum.TextYAlignment.Top
infoText.TextWrapped = true
infoText.ZIndex = 5

-- OPTIONS TAB CONTENT
local optionsContent = Instance.new("ScrollingFrame", contentContainer)
optionsContent.Name = "OptionsContent"
optionsContent.Size = UDim2.fromScale(1, 1)
optionsContent.BackgroundTransparency = 1
optionsContent.BorderSizePixel = 0
optionsContent.ScrollBarThickness = 6
optionsContent.ScrollBarImageColor3 = COLORS.PRIMARY
optionsContent.ScrollBarImageTransparency = 0.3
optionsContent.CanvasSize = UDim2.fromOffset(490, 0)
optionsContent.AutomaticCanvasSize = Enum.AutomaticSize.Y
optionsContent.Visible = false
optionsContent.ZIndex = 3

local optionsLayout = Instance.new("UIListLayout", optionsContent)
optionsLayout.SortOrder = Enum.SortOrder.LayoutOrder
optionsLayout.Padding = UDim.new(0, 12)

-- Set base button
local setBaseButton = Instance.new("TextButton", optionsContent)
setBaseButton.Size = UDim2.fromOffset(490, 60)
setBaseButton.BackgroundColor3 = COLORS.PRIMARY
setBaseButton.BackgroundTransparency = 0.15
setBaseButton.Text = "üìç SET BASE TO CURRENT POSITION"
setBaseButton.Font = Enum.Font.GothamBold
setBaseButton.TextSize = 14
setBaseButton.TextColor3 = COLORS.TEXT
setBaseButton.BorderSizePixel = 0
setBaseButton.AutoButtonColor = false
setBaseButton.ZIndex = 4
Instance.new("UICorner", setBaseButton).CornerRadius = UDim.new(0, 14)

local setBaseStroke = Instance.new("UIStroke", setBaseButton)
setBaseStroke.Color = COLORS.PRIMARY_LIGHT
setBaseStroke.Thickness = 1.5
setBaseStroke.Transparency = 0.4

local baseButtonCooldown = false
setBaseButton.MouseButton1Click:Connect(function()
	if baseButtonCooldown then return end
	baseButtonCooldown = true
	
	if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
		baseCenter = player.Character.HumanoidRootPart.Position
		setBaseButton.Text = "‚úÖ BASE POSITION SET!"
		print("üìç Base position set to:", baseCenter)
		task.wait(2)
		if setBaseButton and setBaseButton.Parent then
			setBaseButton.Text = "üìç SET BASE TO CURRENT POSITION"
		end
	else
		setBaseButton.Text = "‚ùå FAILED - TRY AGAIN"
		task.wait(2)
		if setBaseButton and setBaseButton.Parent then
			setBaseButton.Text = "üìç SET BASE TO CURRENT POSITION"
		end
	end
	
	baseButtonCooldown = false
end)

-- Options sliders
createSlider(
	optionsContent, 72, "Detection Range", "üìè", 20, 200, 50, " studs",
	function(value)
		Settings.DefenseRange = value
	end
)

createSlider(
	optionsContent, 164, "Detection Delay", "‚è±Ô∏è", 0, 5, 0.5, "s",
	function(value)
		Settings.DetectionDelay = value
	end
)

createSlider(
	optionsContent, 256, "Cooldown Time", "‚è≥", 5, 60, 15, "s",
	function(value)
		Settings.CooldownTime = value
	end
)

createSlider(
	optionsContent, 348, "Command Delay", "‚öôÔ∏è", 0.1, 2, 0.2, "s",
	function(value)
		Settings.CommandDelay = value
	end
)

-- Admin commands toggle
local adminCmdsToggle = createToggle(
	optionsContent, 440, "Use Admin Commands", "üîß", true,
	function(state)
		Settings.UseAdminCommands = state
		print("üîß Admin Commands:", state and "ENABLED" or "DISABLED")
	end
)

-- ESP options
local showDistToggle = createToggle(
	optionsContent, 512, "Show Distance on ESP", "üìç", true,
	function(state)
		Settings.ShowDistance = state
	end
)

local showNameToggle = createToggle(
	optionsContent, 584, "Show Names on ESP", "üè∑Ô∏è", true,
	function(state)
		Settings.ShowName = state
	end
)

-- PLAYERS TAB CONTENT
local playersContent = Instance.new("Frame", contentContainer)
playersContent.Name = "PlayersContent"
playersContent.Size = UDim2.fromScale(1, 1)
playersContent.BackgroundTransparency = 1
playersContent.Visible = false
playersContent.ZIndex = 3

local playersList = Instance.new("ScrollingFrame", playersContent)
playersList.Size = UDim2.fromScale(1, 1)
playersList.BackgroundColor3 = COLORS.BG_CARD
playersList.BackgroundTransparency = 0.35
playersList.BorderSizePixel = 0
playersList.ScrollBarThickness = 6
playersList.ScrollBarImageColor3 = COLORS.DANGER
playersList.ScrollBarImageTransparency = 0.3
playersList.CanvasSize = UDim2.fromOffset(490, 0)
playersList.AutomaticCanvasSize = Enum.AutomaticSize.Y
playersList.ZIndex = 3
Instance.new("UICorner", playersList).CornerRadius = UDim.new(0, 18)

local playersLayout = Instance.new("UIListLayout", playersList)
playersLayout.SortOrder = Enum.SortOrder.LayoutOrder
playersLayout.Padding = UDim.new(0, 10)

local playersPadding = Instance.new("UIPadding", playersList)
playersPadding.PaddingTop = UDim.new(0, 12)
playersPadding.PaddingBottom = UDim.new(0, 12)
playersPadding.PaddingLeft = UDim.new(0, 12)
playersPadding.PaddingRight = UDim.new(0, 12)

-- Player tracking (improved)
local playerAddedConn = Players.PlayerAdded:Connect(function(newPlayer)
	task.wait(0.5)
	if isShuttingDown then return end
	if newPlayer ~= player then
		pcall(function()
			if newPlayer.Character then
				createPlayerCard(newPlayer)
				createESPBox(newPlayer)
			end
		end)
	end
end)

table.insert(detectionConnections, playerAddedConn)

local playerRemovingConn = Players.PlayerRemoving:Connect(function(removedPlayer)
	if isShuttingDown then return end
	
	pcall(function()
		if playerCards[removedPlayer.UserId] then
			local data = playerCards[removedPlayer.UserId]
			safeDisconnect(data.connection)
			safeDestroy(data.card)
			playerCards[removedPlayer.UserId] = nil
		end
		
		if playerESP[removedPlayer.UserId] then
			local espData = playerESP[removedPlayer.UserId]
			safeDisconnect(espData.connection)
			safeDestroy(espData.box)
			playerESP[removedPlayer.UserId] = nil
		end
	end)
end)

table.insert(detectionConnections, playerRemovingConn)

-- Character added handler for ESP
for _, newPlayer in pairs(Players:GetPlayers()) do
	if newPlayer ~= player then
		local charAddedConn = newPlayer.CharacterAdded:Connect(function()
			task.wait(0.5)
			if isShuttingDown then return end
			pcall(function()
				createESPBox(newPlayer)
			end)
		end)
		table.insert(detectionConnections, charAddedConn)
	end
end

-- Initialize players
refreshPlayerList()

-- Entrance animation
defensePanel.Size = UDim2.fromOffset(0, 0)
defensePanel.Position = UDim2.new(0.5, 0, 0.5, 0)
defensePanel.BackgroundTransparency = 1

createTrackedTween(defensePanel, TweenInfo.new(0.8, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
	Size = UDim2.fromOffset(520, 720),
	Position = UDim2.new(0.5, -260, 0.5, -360),
	BackgroundTransparency = 0.08
}):Play()

task.wait(0.4)

for _, child in pairs(defensePanel:GetDescendants()) do
	if child:IsA("TextLabel") or child:IsA("TextButton") then
		local origTrans = child.TextTransparency
		child.TextTransparency = 1
		createTrackedTween(child, TweenInfo.new(0.6), {TextTransparency = origTrans}):Play()
	end
end

print("‚úÖ Ducky Auto Defense v3.2 (Improved) loaded!")
print("üîß IMPROVEMENTS: Better error handling, memory leak fixes, performance optimized")
print("üõ°Ô∏è Stealer Protector & Base Detector ready")
print("üë• Tracking", #Players:GetPlayers() - 1, "players")
print("‚ö° Enable protection features in Main tab")
